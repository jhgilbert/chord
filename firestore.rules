rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // To restrict access to specific email domains, use a regex like:
    //   && request.auth.token.email.matches('.*@(example[.]com|other[.]org)');
    // To allow any Google account, remove the email.matches line.
    function isSignedIn() {
      return request.auth != null
        // && request.auth.token.email.matches('.*@datadoghq[.]com');
    }

    // Users â€” can only write your own doc
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == userId;
    }

    // Collaborations
    match /collaborations/{collabId} {
      allow read: if isSignedIn();

      // Only the creator's uid can be set as startedBy
      allow create: if isSignedIn()
        && request.resource.data.startedBy == request.auth.uid;

      // Only the host can update collaboration settings
      allow update: if isSignedIn()
        && resource.data.startedBy == request.auth.uid;

      // Notes subcollection
      match /notes/{noteId} {
        allow read: if isSignedIn();

        // Any signed-in user can create a note, but createdBy must match their uid
        allow create: if isSignedIn()
          && request.resource.data.createdBy == request.auth.uid;

        // Updates come from multiple actors: author edits, others react/respond/vote, host groups/archives
        allow update: if isSignedIn();

        // Only the note author can delete
        allow delete: if isSignedIn()
          && resource.data.createdBy == request.auth.uid;
      }
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
