rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // To restrict access to specific email domains, use a regex like:
    //   && request.auth.token.email.matches('.*@(example[.]com|other[.]org)');
    // To allow any Google account, remove the email.matches line.
    function isSignedIn() {
      return request.auth != null
        // && request.auth.token.email.matches('.*@datadoghq[.]com');
    }

    // Users — can only write your own doc
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == userId;
    }

    // Collaborations
    match /collaborations/{collabId} {
      allow read: if isSignedIn();

      // Only the creator's uid can be set as startedBy
      allow create: if isSignedIn()
        && request.resource.data.startedBy == request.auth.uid;

      // Only the host can update collaboration settings
      allow update: if isSignedIn()
        && resource.data.startedBy == request.auth.uid;

      // Participants subcollection — waiting room / approval
      match /participants/{userId} {
        allow read: if isSignedIn();

        // A user can create their own participant doc with status "pending"
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.status == "pending";

        // Only the host can update (to approve or revoke participants)
        allow update: if isSignedIn()
          && get(/databases/$(database)/documents/collaborations/$(collabId)).data.startedBy == request.auth.uid;
      }

      // Notes subcollection
      match /notes/{noteId} {
        allow read: if isSignedIn();

        // Only the host or approved participants can create notes
        allow create: if isSignedIn()
          && request.resource.data.createdBy == request.auth.uid
          && (
            // Host can always create notes
            get(/databases/$(database)/documents/collaborations/$(collabId)).data.startedBy == request.auth.uid
            // Approved participants can create notes
            || get(/databases/$(database)/documents/collaborations/$(collabId)/participants/$(request.auth.uid)).data.status == "approved"
          );

        // Updates come from multiple actors: author edits, others react/respond/vote, host groups/archives
        // Only the host or approved participants can update notes
        allow update: if isSignedIn()
          && (
            get(/databases/$(database)/documents/collaborations/$(collabId)).data.startedBy == request.auth.uid
            || get(/databases/$(database)/documents/collaborations/$(collabId)/participants/$(request.auth.uid)).data.status == "approved"
          );

        // Only the note author can delete
        allow delete: if isSignedIn()
          && resource.data.createdBy == request.auth.uid;
      }
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
